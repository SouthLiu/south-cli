import type { IFormData } from '#/form'
import type { RootState } from '@/stores'
import type { IPagePermission, ITableOptions } from '#/public'
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
import type { IFormFn } from '@/components/Form/BasicForm'
<% } -%>
import { useEffect, useMemo<% if (funcs.includes('create') || funcs.includes('update')) { %>, useRef<% } %>, useState } from 'react'
import { <% if (funcs.includes('search')) { -%>searchList, <% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>createList, <% } -%>
tableColumns } from './data'
<% if (funcs.includes('create') || funcs.includes('update') || funcs.includes('delete')) { -%>
import { message } from 'antd'
<% } -%>
<% if (funcs.includes('search') || funcs.includes('delete')) { -%>
import { useLoading } from '@/hooks/useLoading'
<% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
import { useCreateLoading } from '@/hooks/useCreateLoading'
<% } -%>
import { useSelector } from 'react-redux'
import { checkPermission } from '@/utils/permissions'
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
import { ADD_TITLE, EDIT_TITLE } from '@/utils/config'
import { UpdateBtn, DeleteBtn } from '@/components/Buttons'
<% } -%>
<% if (funcs.includes('create') && funcs.includes('update') && funcs.includes('delete')) { -%>
import {
  get<%=name%>Page<% if (funcs.includes('update')) { %>,
  get<%=name%>ById<% } -%><% if (funcs.includes('create')) { %>,
  create<%=name%><% } -%><% if (funcs.includes('update')) { %>,
  update<%=name%><% } -%><% if (funcs.includes('delete')) { %>,
  delete<%=name%><% } %>
} from './<%=apiName%>'
<% } else { -%>
import { get<%=name%>Page<% if (funcs.includes('update')) { -%>, get<%=name%>ById<% } -%>
<% if (funcs.includes('create')) { -%>, create<%=name%><% } -%>
<% if (funcs.includes('update')) { -%>, update<%=name%><% } -%>
<% if (funcs.includes('delete')) { -%>, delete<%=name%><% } -%> } from './<%=apiName%>'
<% } -%>
import BasicContent from '@/components/Content/BasicContent'
<% if (funcs.includes('search')) { -%>
import BasicSearch from '@/components/Search/BasicSearch'
<% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
import BasicModal from '@/components/Modal/BasicModal'
import BasicForm from '@/components/Form/BasicForm'
<% } -%>
import BasicTable from '@/components/Table/BasicTable'
<% if (funcs.includes('pagination')) { -%>
import BasicPagination from '@/components/Pagination/BasicPagination'
<% } -%>

// 当前行数据
export interface IRowData {
  id: string;
}
<% if (funcs.includes('create') || funcs.includes('update')) { -%>

// 初始化新增数据
const initCreate = {
  status: 1
}
<% } -%>

function User() {
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
  const createFormRef = useRef<IFormFn>(null)
<% } -%>
<% if (funcs.includes('search')) { -%>
  const [searchData, setSearchData] = useState<IFormData>({})
<% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
  const [isCreateOpen, setCreateOpen] = useState(false)
  const [createTitle, setCreateTitle] = useState(ADD_TITLE)
  const [createId, setCreateId] = useState('')
  const [createData, setCreateData] = useState<IFormData>(initCreate)
<% } -%>
<% if (funcs.includes('pagination')) { -%>
  const [page, setPage] = useState(1)
  const [pageSize, setPageSize] = useState(20)
  const [total, setTotal] = useState(1)
<% } -%>
  const [tableData, setTableData] = useState<IFormData[]>([])
  const permissions = useSelector((state: RootState) => state.user.permissions)

  const { isLoading, startLoading, endLoading } = useLoading()
<% if (funcs.includes('create') || funcs.includes('update')) { -%>
  const { isCreateLoading, startCreateLoading, endCreateLoading } = useCreateLoading()
<% } -%>

  // 权限前缀
  const permissionPrefix = '<%=rule%>'

  // 权限
  const pagePermission: IPagePermission = useMemo(() => {
    return {
      page: checkPermission(`${permissionPrefix}/index`, permissions),
<% if (funcs.includes('create')) { -%>
      create: checkPermission(`${permissionPrefix}/create`, permissions),
<% } -%>
<% if (funcs.includes('update')) { -%>
      update: checkPermission(`${permissionPrefix}/update`, permissions),
<% } -%>
<% if (funcs.includes('delete')) { -%>
      delete: checkPermission(`${permissionPrefix}/delete`, permissions)
<% } -%>
    }
  }, [permissions])

  useEffect(() => {
    if (pagePermission.page) getPage()
  }, [permissions])

  /** 获取表格数据 */
  const getPage = () => {
    handleSearch(searchData)
  }
<% if (funcs.includes('search')) { -%>

  /**
   * 搜索提交
   * @param values - 表单返回数据
   */
  const handleSearch = async (values: IFormData) => {
    setSearchData(values)
    const query = { page, pageSize, ...values }
    try {
      startLoading()
      const { data: { data } } = await get<%=name%>Page(query)
      const { items<% if (funcs.includes('pagination')) { -%>, total<% } -%> } = data
<% if (funcs.includes('pagination')) { -%>
      setTotal(total)
<% } -%>
      setTableData(items)
    } finally {
      endLoading()
    }
  }
<% } -%>
<% if (funcs.includes('create')) { -%>

  /** 点击新增 */
  const onCreate = () => {
    setCreateOpen(true)
    setCreateTitle(ADD_TITLE)
    setCreateId('')
    setCreateData(initCreate)
  }
<% } -%>
<% if (funcs.includes('update')) { -%>

  /**
   * 点击编辑
   * @param id - 唯一值
   */
  const onUpdate = async (id: string) => {
    setCreateOpen(true)
    setCreateTitle(EDIT_TITLE(id))
    setCreateId(id)
    setCreateData(initCreate)

    try {
      startCreateLoading()
      const { data: { data } } = await get<%=name%>ById(id as string)
      setCreateData(data)
    } finally {
      endCreateLoading()
    }
  }
<% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>

  /** 表格提交 */
  const createSubmit = () => {
    createFormRef.current?.handleSubmit()
  }

  /**
   * 新增/编辑提交
   * @param values - 表单返回数据
   */
  const handleCreate = async (values: IFormData) => {
    try {
      startCreateLoading()
      const functions = () => createId ? update<%=name%>(createId, values) : create<%=name%>(values)
      const { data } = await functions()
      getPage()
      setCreateOpen(false)
      createFormRef.current?.handleReset()
      message.success(data?.message || '操作成功')
    } finally {
      endCreateLoading()
    }
  }
<% } -%>
<% if (funcs.includes('delete')) { -%>

  /**
   * 点击删除
   * @param id - 唯一值
   */
  const onDelete = async (id: string) => {
    try {
      startLoading()
      const { data } = await delete<%=name%>(id as string)
      if (data?.code === 200) {
        message.success(data?.message || '删除成功')
        getPage()
      }
    } finally {
      endLoading()
    }
  }
<% } -%>
<% if (funcs.includes('pagination')) { -%>

  /**
   * 处理分页
   * @param page - 当前页数
   * @param pageSize - 每页条数
   */
  const onChangePagination = (page: number, pageSize: number) => {
    setPage(page)
    setPageSize(pageSize)
    handleSearch({ ...searchData, page, pageSize })
  }
<% } -%>

  /**
   * 渲染操作
   * @param _ - 当前值
   * @param record - 当前行参数
   */
  const optionRender: ITableOptions<IRowData> = (_, record) => (
    <>
<% if (funcs.includes('create')) { -%>
      {
        pagePermission.update === true &&
        <UpdateBtn
          className='mr-5px'
          isLoading={isLoading}
          onClick=<%- '{() => onUpdate(record.id)}' %>
        />
      }
<% } -%>
<% if (funcs.includes('update')) { -%>
      {
        pagePermission.delete === true &&
        <DeleteBtn
          className='mr-5px'
          isLoading={isLoading}
          handleDelete=<%- '{() => onDelete(record.id)}' %>
        />
      }
<% } -%>
    </>
  )

  return (
    <BasicContent isPermission={pagePermission.page}>
      <>
<% if (funcs.includes('search')) { -%>
        <BasicSearch
          list={searchList}
          data={searchData}
          isLoading={isLoading}
          isCreate={pagePermission.create}
          onCreate={onCreate}
          handleFinish={handleSearch}
        />
        
<% } -%>
        <BasicTable
          columns={tableColumns(optionRender)}
          dataSource={tableData}
        />
<% if (funcs.includes('pagination')) { -%>

        <BasicPagination
          isLoading={isLoading}
          defaultCurrent={page}
          defaultPageSize={pageSize}
          total={total}
          onChange={onChangePagination}
        />
<% } -%>
<% if (funcs.includes('create') || funcs.includes('update')) { -%>

        <BasicModal
          title={createTitle}
          isOpen={isCreateOpen}
          confirmLoading={isCreateLoading}
          onOk={createSubmit}
          onCancel=<%- '{() => setCreateOpen(false)}' %>
        >
          <BasicForm
            formRef={createFormRef}
            list={createList}
            data={createData}
            labelCol={{ span: 6 }}
            handleFinish={handleCreate}
          />
        </BasicModal>
<% } -%>
      </>
    </BasicContent>
  )
}

export default User